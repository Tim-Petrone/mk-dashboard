<?xml version="1.0" encoding="UTF-8"?>
<secas xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:noNamespaceSchemaLocation="http://moqui.org/xsd/service-eca-2.1.xsd">

    <!-- Order service validation -->
    <seca service="mkdecision\.dashboard\.OrderServices\.(.+)" name-is-pattern="true" when="pre-service">
        <actions>
            <if condition="orderId != null &amp;&amp; !orderId.trim().equals('')">
                <entity-find-one entity-name="mantle.order.OrderHeader" value-field="orderHeader"/>
                <if condition="orderHeader != null">

                    <!-- check if order is locked -->
                    <if condition="orderHeader.lockUserId != null &amp;&amp; orderHeader.lockUserId != ec.user.userId">
                        <return error="true" message="${ec.getL10n().localize('DASHBOARD_ORDER_NOT_EDITABLE')}"/>
                    </if>
                    
                    <!-- check if order status is editable -->
                    <entity-find-count entity-name="moqui.basic.StatusFlowItem" count-field="editableOrderStatusCount">
                        <econditions>
                            <econdition field-name="statusFlowId" value="MkDashboardEditableOrderStatuses"/>
                            <econdition field-name="statusId" from="orderHeader.statusId"/>
                        </econditions>
                    </entity-find-count>
                    <if condition="editableOrderStatusCount == 0">
                        <return error="true" message="${ec.getL10n().localize('DASHBOARD_ORDER_NOT_EDITABLE')}"/>
                    </if>
                </if>
            </if>
        </actions>
    </seca>

</secas>